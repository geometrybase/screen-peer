!function(){"use strict";function e(e,t,n,o,i,r,s){function a(o,i,r){e.call(this),this.options=n.extend({serialization:"json",type:"sync",reliable:!1},r),this._lostMessages=[],this.idPrefix="dc_",this.open=!1,this.destroyed=!1,this.type=this.options.type,this.peer=o,this.options._payload?this.originator=!1:this.originator=!0,this.provider=i,this.id=this.options.connectionId||this.idPrefix+n.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this.timeouts={},this.callbacks={},this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),t.startConnection(this,this.options._payload||{originator:!0})}var c=n.logger("DataConnection");return n.inherits(a,e),a.prototype.initialize=function(e){this._dc=this.dataChannel=e,this._configureDataChannel()},a.prototype._configureDataChannel=function(){c.debug("Config data channel",this._dc);var e=this;n.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onerror=function(e){c.error("data channel error",e)},this._dc.onopen=function(){c.debug("Data chnnel connection success"),e.open=!0,e.sendLostMessage(),e.emit("open")},this._dc.onmessage=function(t){e._handleDataMessage(t)},this._dc.onbufferedamountlow=function(){c.warn("onbufferedamountlow")},this._dc.onclose=function(n){c.debug("DataChannel closed for:",e.peer),!e.destroyed&&e.originator&&t.startConnection(e,{originator:!0})}},a.prototype._handleDataMessage=function(e){var t=e.data;if(t.constructor,"json"===this.serialization&&angular.isString(t)){Date.now();try{t=angular.fromJson(t)}catch(e){}}if(t.__peerData){var n=t.__peerData,o=this._chunkedData[n]||{data:[],count:0,timeStamp:Date.now(),total:t.total};return o.data[t.n]=t.data,o.count+=1,void(o.total===o.count?(delete this._chunkedData[n],"json"===this.serialization&&(t=o.data.join("")),this._handleDataMessage({data:t})):this._chunkedData[n]=o)}"RESPONSE"===t.type&&this.callbacks[t.id]?(i.cancel(this.timeouts[t.id]),this.callbacks[t.id](null,t.payload),delete this.callbacks[t.id]):"DATA"===t.type?this.provider.emit("data",{peer:this.peer,payload:t.payload}):"REQUEST"===t.type&&this.provider.emit("action",{peer:this.peer,payload:t.payload,id:t.id})},a.prototype.disconnect=function(){this.open&&(this.open=!1,t.cleanup(this),this.emit("disconnect"))},a.prototype.destroy=function(){this.destroyed=!0,this.removeAllListeners(),this.disconnect()},a.prototype.sendRequest=function(e,t,n){c.debug("DataConnection.sendRequest(data,timeout,callback) called.");var o=this,s=r.v4();this.send({type:"REQUEST",payload:e,id:s}),this.callbacks[s]=n,this.timeouts[s]=i(function(){delete o.timeouts[s],delete o.callbacks[s],n("No action response in "+t)},t)},a.prototype.sendResponse=function(e,t){this.send({type:"RESPONSE",payload:t,id:e,peer:this.provider.id})},a.prototype.sendData=function(e){this.send({type:"DATA",payload:e})},a.prototype.sendLostMessage=function(){var e=this;this._lostMessages.forEach(function(t){e.send(t.data,t.chunked)})},a.prototype.send=function(e,t){if(this.destroyed)return this.emit("error",new Error("Connection is destroyed."));if(!this.open)return this._lostMessages.push({data:e,chunked:t});var o=this;if("json"===this.serialization){angular.isString(e)||Date.now(),e=angular.toJson(e);var i=n.chunkedBrowsers[this._peerBrowser]||n.chunkedBrowsers[n.brower];i&&!t&&e.length>n.chunkedMTU?this._sendChunks(e):this._bufferedSend(e)}else o._bufferedSend(ab)},a.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this.bufferSize=this._buffer.length)},a.prototype._trySend=function(e){try{this._dc.send(e)}catch(t){c.debug(t),this._buffering=!0;var n=this;return i(function(){n._buffering=!1,n._tryBuffer()},10),!1}},a.prototype._tryBuffer=function(){if(0!==this._buffer.length){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},a.prototype._sendChunks=function(e){var t=this,o=n.chunkString(e);c.debug("chunks length",o.length),o.forEach(function(e){t.send(e,!0)})},a.prototype.handleMessage=function(e){var n=e.payload;switch(e.type){case"ANSWER":c.debug("handle ANSWER for",e.src,"sdp",n.sdp),this._peerBrowser=n.browser,t.handleSDP(e.type,this,n.sdp);break;case"CANDIDATE":c.debug("handle CANDIDATE for",e.src),t.handleCandidate(this,n.candidate);break;default:c.warn("Unrecogized message type:",e.type,"from peer:",this.peer)}},a}angular.module("screenPeer").factory("DataConnection",e)}(),function(){"use strict";function e(e,t,n,o,i,r,s){function a(o,i,r){e.call(this),this.options=n.extend({serialization:"json",type:"sync",reliable:!1},r),this._lostMessages=[],this.idPrefix="dc_",this.open=!1,this.destroyed=!1,this.type=this.options.type,this.peer=o,this.options._payload?this.originator=!1:this.originator=!0,this.provider=i,this.id=this.options.connectionId||this.idPrefix+n.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this.timeouts={},this.callbacks={},this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),t.startConnection(this,this.options._payload||{originator:!0})}var c=n.logger("DataConnection");return n.inherits(a,e),a.prototype.initialize=function(e){this._dc=this.dataChannel=e,this._configureDataChannel()},a.prototype._configureDataChannel=function(){c.debug("Config data channel",this._dc);var e=this;n.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onerror=function(e){c.error("data channel error",e)},this._dc.onopen=function(){c.debug("Data chnnel connection success"),e.open=!0,e.sendLostMessage(),e.emit("open")},this._dc.onmessage=function(t){e._handleDataMessage(t)},this._dc.onbufferedamountlow=function(){c.warn("onbufferedamountlow")},this._dc.onclose=function(n){c.debug("DataChannel closed for:",e.peer),!e.destroyed&&e.originator&&t.startConnection(e,{originator:!0})}},a.prototype._handleDataMessage=function(e){var t=e.data;t.constructor;if("json"===this.serialization&&angular.isString(t)){Date.now();try{t=angular.fromJson(t)}catch(e){}}if(t.__peerData){var n=t.__peerData,o=this._chunkedData[n]||{data:[],count:0,timeStamp:Date.now(),total:t.total};return o.data[t.n]=t.data,o.count+=1,void(o.total===o.count?(delete this._chunkedData[n],"json"===this.serialization&&(t=o.data.join("")),this._handleDataMessage({data:t})):this._chunkedData[n]=o)}"RESPONSE"===t.type&&this.callbacks[t.id]?(i.cancel(this.timeouts[t.id]),this.callbacks[t.id](null,t.payload),delete this.callbacks[t.id]):"DATA"===t.type?this.provider.emit("data",{peer:this.peer,payload:t.payload}):"REQUEST"===t.type&&this.provider.emit("action",{peer:this.peer,payload:t.payload,id:t.id})},a.prototype.disconnect=function(){this.open&&(this.open=!1,t.cleanup(this),this.emit("disconnect"))},a.prototype.destroy=function(){this.destroyed=!0,this.removeAllListeners(),this.disconnect()},a.prototype.sendRequest=function(e,t,n){c.debug("DataConnection.sendRequest(data,timeout,callback) called.");var o=this,s=r.v4();this.send({type:"REQUEST",payload:e,id:s}),this.callbacks[s]=n,this.timeouts[s]=i(function(){delete o.timeouts[s],delete o.callbacks[s],n("No action response in "+t)},t)},a.prototype.sendResponse=function(e,t){this.send({type:"RESPONSE",payload:t,id:e,peer:this.provider.id})},a.prototype.sendData=function(e){this.send({type:"DATA",payload:e})},a.prototype.sendLostMessage=function(){var e=this;this._lostMessages.forEach(function(t){e.send(t.data,t.chunked)})},a.prototype.send=function(e,t){if(this.destroyed)return this.emit("error",new Error("Connection is destroyed."));if(!this.open)return this._lostMessages.push({data:e,chunked:t});var o=this;if("json"===this.serialization){if(!angular.isString(e)){Date.now()}e=angular.toJson(e);var i=n.chunkedBrowsers[this._peerBrowser]||n.chunkedBrowsers[n.brower];i&&!t&&e.length>n.chunkedMTU?this._sendChunks(e):this._bufferedSend(e)}else o._bufferedSend(ab)},a.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this.bufferSize=this._buffer.length)},a.prototype._trySend=function(e){try{this._dc.send(e)}catch(t){c.debug(t),this._buffering=!0;var n=this;return i(function(){n._buffering=!1,n._tryBuffer()},10),!1}},a.prototype._tryBuffer=function(){if(0!==this._buffer.length){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},a.prototype._sendChunks=function(e){var t=this,o=n.chunkString(e);c.debug("chunks length",o.length),o.forEach(function(e){t.send(e,!0)})},a.prototype.handleMessage=function(e){var n=e.payload;switch(e.type){case"ANSWER":c.debug("handle ANSWER for",e.src,"sdp",n.sdp),this._peerBrowser=n.browser,t.handleSDP(e.type,this,n.sdp);break;case"CANDIDATE":c.debug("handle CANDIDATE for",e.src),t.handleCandidate(this,n.candidate);break;default:c.warn("Unrecogized message type:",e.type,"from peer:",this.peer)}},a}angular.module("screenPeer").factory("DataConnection",e)}(),!function(){"use strict";function e(e){return e.msgpack}function t(e){return e.uuid}function n(e){return e.d3}function o(e){return e.RTCSessionDescription||e.mozRTCSessionDescription}function i(e){return e.RTCPeerConnection||e.mozRTCPeerConnection||e.webkitRTCPeerConnection}function r(e){return e.RTCIceCandidate||e.mozRTCIceCandidate}function s(e){return e.BinaryPack}function a(e){return e.io}function c(e){return e._}function d(e){return e.EventEmitter}function u(e){return 0}angular.module("screenPeer").factory("RTCSessionDescription",o).factory("RTCPeerConnection",i).factory("RTCIceCandidate",r).factory("BinaryPack",s).factory("io",a).factory("_",c).factory("EventEmitter",d).factory("d3",n).factory("uuid",t).factory("msgpack",e).factory("Reliable",u)}(),function(){"use strict";function e(e){return e.msgpack}function t(e){return e.uuid}function n(e){return e.d3}function o(e){return e.RTCSessionDescription||e.mozRTCSessionDescription}function i(e){return e.RTCPeerConnection||e.mozRTCPeerConnection||e.webkitRTCPeerConnection}function r(e){return e.RTCIceCandidate||e.mozRTCIceCandidate}function s(e){return e.BinaryPack}function a(e){return e.io}function c(e){return e._}function d(e){return e.EventEmitter}function u(e){return 0}angular.module("screenPeer").factory("RTCSessionDescription",o).factory("RTCPeerConnection",i).factory("RTCIceCandidate",r).factory("BinaryPack",s).factory("io",a).factory("_",c).factory("EventEmitter",d).factory("d3",n).factory("uuid",t).factory("msgpack",e).factory("Reliable",u)}(),!function(){"use strict";function e(e,t,n,o,i,r){var s=i.logger("Negotiator"),a={pcs:{data:{},media:{},sync:{}},queue:[]};return a._idPrefix="pc_",a.startConnection=function(e,t){var n=a._getPeerConnection(e,t);if(e.pc=e.peerConnection=n,t.originator){var o={ordered:!1};i.supports.sctp||(o={reliable:t.reliable});var r=n.createDataChannel(e.label,o);e.initialize(r)}else a.handleSDP("OFFER",e,t.sdp)},a._getPeerConnection=function(e,t){a.pcs[e.type]||s.error(e.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),a.pcs[e.type][e.peer]||(a.pcs[e.type][e.peer]={});var n;return t.pc&&(n=a.pcs[e.type][e.peer][t.pc]),n&&"stable"===n.signalingState||(n=a._startPeerConnection(e)),s.debug(n),n},a._startPeerConnection=function(e){s.debug("Creating RTCPeerConnection");var n=a._idPrefix+i.randomToken(),o={};i.supports.sctp||(o={optional:[{RtpDataChannels:!0}]});var r=new t(e.provider.options.config,o);return a.pcs[e.type][e.peer][n]=r,a._setupListeners(e,r,n),r},a._setupListeners=function(e,t,n){var o=e.peer,r=e.id,c=e.provider;s.debug("Listening for ICE candidates"),t.onicecandidate=function(t){t.candidate&&(s.debug("Receive ICE candidates for:",e.peer),s.debug(t.candidate),s.debug("send to",o),c.socket.emit("message",{type:"CANDIDATE",payload:{candidate:t.candidate,type:e.type,connectionId:e.id},dst:o}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"failed":s.debug("iceConnectionState is disconnected, closing connections to "+o),e.emit("error",new Error("Negotiation of connection to "+o+" failed.")),!e.destroyed&&e.originator&&a.startConnection(e,{originator:!0});break;case"disconnected":s.debug("iceConnectionState is disconnected, closing connections to "+o),!e.destroyed&&e.originator&&a.startConnection(e,{originator:!0});break;case"completed":s.debug("oniceconnectionstatechange completed"),t.onicecandidate=i.noop}},t.onicechange=t.oniceconnectionstatechange,s.debug("Listening for `negotiationneeded`"),t.onnegotiationneeded=function(){s.debug("`negotiationneeded` triggered"),"stable"==t.signalingState?a._makeOffer(e):s.debug("onnegotiationneeded triggered when not stable. Is another connection being established?")},s.debug("Listening for data channel"),t.ondatachannel=function(e){s.debug("Receive data channel");var t=e.channel,n=c.getConnection(o,r);n.initialize(t)}},a.cleanup=function(e){s.debug("Cleaning up PeerConnection to "+e.peer);var t=e.pc;!t||"closed"===t.readyState&&"closed"===t.signalingState||(t.close(),e.pc=null)},a._makeOffer=function(e){s.debug("make offer for:",e.peer);var t=e.pc;t.createOffer(function(n){!i.supports.sctp&&e.reliable&&(n.sdp=r.higherBandwidthSDP(n.sdp)),t.setLocalDescription(n,function(){s.debug("Set localDescription: offer","for:",e.peer),e.provider.socket.emit("message",{type:"OFFER",payload:{sdp:n,type:e.type,lable:e.label,connectionId:e.id,reliable:e.reliable,serialization:e.serialization,browser:i.browser},dst:e.peer})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to setLocalDescription,",t)})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to createOffer,",t)},e.options.constraints)},a._makeAnswer=function(e){var t=e.pc;t.createAnswer(function(n){s.debug("Created answer."),!i.supports.sctp&&e.reliable&&(n.sdp=r.higherBandwidthSDP(n.sdp)),t.setLocalDescription(n,function(){e.provider.socket.emit("message",{type:"ANSWER",payload:{sdp:n,type:e.type,connectionId:e.id,browser:i.browser},dst:e.peer})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to setLocalDescription")})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to create answer,",t)})},a.handleSDP=function(e,t,o){s.debug("SDP",o),o=new n(o);var r=t.pc;s.debug("Setting remote description",o),r.setRemoteDescription(o,function(){s.debug("Set remoteDescription:",e,"for:",t.peer),"OFFER"===e&&a._makeAnswer(t)},function(e){t.provider.emitError("webrtc",e),i.log("Failed to setRemoteDescription,",e)})},a.handleCandidate=function(e,t){var n=t.candidate,i=t.sdpMLineIndex;e.pc.addIceCandidate(new o({sdpMLineIndex:i,candidate:n})),s.debug("Added ICE candidate for:",e.peer)},a}angular.module("screenPeer").factory("Negotiator",e)}(),function(){"use strict";function e(e,t,n,o,i,r){var s=i.logger("Negotiator"),a={pcs:{data:{},media:{},sync:{}},queue:[]};return a._idPrefix="pc_",a.startConnection=function(e,t){var n=a._getPeerConnection(e,t);if(e.pc=e.peerConnection=n,t.originator){var o={ordered:!1};i.supports.sctp||(o={reliable:t.reliable});var r=n.createDataChannel(e.label,o);e.initialize(r)}else a.handleSDP("OFFER",e,t.sdp)},a._getPeerConnection=function(e,t){a.pcs[e.type]||s.error(e.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),a.pcs[e.type][e.peer]||(a.pcs[e.type][e.peer]={});var n;return t.pc&&(n=a.pcs[e.type][e.peer][t.pc]),n&&"stable"===n.signalingState||(n=a._startPeerConnection(e)),s.debug(n),n},a._startPeerConnection=function(e){s.debug("Creating RTCPeerConnection");var n=a._idPrefix+i.randomToken(),o={};i.supports.sctp||(o={optional:[{RtpDataChannels:!0}]});var r=new t(e.provider.options.config,o);return a.pcs[e.type][e.peer][n]=r,a._setupListeners(e,r,n),r},a._setupListeners=function(e,t,n){var o=e.peer,r=e.id,c=e.provider;s.debug("Listening for ICE candidates"),t.onicecandidate=function(t){t.candidate&&(s.debug("Receive ICE candidates for:",e.peer),s.debug(t.candidate),s.debug("send to",o),c.socket.emit("message",{type:"CANDIDATE",payload:{candidate:t.candidate,type:e.type,connectionId:e.id},dst:o}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"failed":s.debug("iceConnectionState is disconnected, closing connections to "+o),e.emit("error",new Error("Negotiation of connection to "+o+" failed.")),!e.destroyed&&e.originator&&a.startConnection(e,{originator:!0});break;case"disconnected":s.debug("iceConnectionState is disconnected, closing connections to "+o),!e.destroyed&&e.originator&&a.startConnection(e,{originator:!0});break;case"completed":s.debug("oniceconnectionstatechange completed"),t.onicecandidate=i.noop}},t.onicechange=t.oniceconnectionstatechange,s.debug("Listening for `negotiationneeded`"),t.onnegotiationneeded=function(){s.debug("`negotiationneeded` triggered"),"stable"==t.signalingState?a._makeOffer(e):s.debug("onnegotiationneeded triggered when not stable. Is another connection being established?")},s.debug("Listening for data channel"),t.ondatachannel=function(e){s.debug("Receive data channel");var t=e.channel,n=c.getConnection(o,r);n.initialize(t)}},a.cleanup=function(e){s.debug("Cleaning up PeerConnection to "+e.peer);var t=e.pc;!t||"closed"===t.readyState&&"closed"===t.signalingState||(t.close(),e.pc=null)},a._makeOffer=function(e){s.debug("make offer for:",e.peer);var t=e.pc;t.createOffer(function(n){!i.supports.sctp&&e.reliable&&(n.sdp=r.higherBandwidthSDP(n.sdp)),t.setLocalDescription(n,function(){s.debug("Set localDescription: offer","for:",e.peer),e.provider.socket.emit("message",{type:"OFFER",payload:{sdp:n,type:e.type,lable:e.label,connectionId:e.id,reliable:e.reliable,serialization:e.serialization,browser:i.browser},dst:e.peer})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to setLocalDescription,",t)})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to createOffer,",t)},e.options.constraints)},a._makeAnswer=function(e){var t=e.pc;t.createAnswer(function(n){s.debug("Created answer."),!i.supports.sctp&&e.reliable&&(n.sdp=r.higherBandwidthSDP(n.sdp)),t.setLocalDescription(n,function(){e.provider.socket.emit("message",{type:"ANSWER",payload:{sdp:n,type:e.type,connectionId:e.id,browser:i.browser},dst:e.peer})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to setLocalDescription")})},function(t){e.provider.emitError("webrtc",t),s.debug("Failed to create answer,",t)})},a.handleSDP=function(e,t,o){s.debug("SDP",o),o=new n(o);var r=t.pc;s.debug("Setting remote description",o),r.setRemoteDescription(o,function(){s.debug("Set remoteDescription:",e,"for:",t.peer),"OFFER"===e&&a._makeAnswer(t)},function(e){t.provider.emitError("webrtc",e),i.log("Failed to setRemoteDescription,",e)})},a.handleCandidate=function(e,t){var n=t.candidate,i=t.sdpMLineIndex;e.pc.addIceCandidate(new o({sdpMLineIndex:i,candidate:n})),s.debug("Added ICE candidate for:",e.peer)},a}angular.module("screenPeer").factory("Negotiator",e)}(),!function(){"use strict";angular.module("screenPeer",[]),angular.module("screenPeer").provider("screenPeerCfg",function(){var e="debug";return{setLogLevel:function(t){e=t},$get:function(){return{logLevel:e}}}})}(),function(){"use strict";angular.module("screenPeer",[]),angular.module("screenPeer").provider("screenPeerCfg",function(){var e="debug";return{setLogLevel:function(t){e=t},$get:function(){return{logLevel:e}}}})}(),!function(){"use strict";function e(e,t,n,o,i,r,s){function a(e){return this instanceof a?(o.call(this),e=i.extend({config:i.defaultConfig},e),this.options=e,this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={all:{}},this._lostMessages={},this.master=!1,i.supports.audioVideo||i.supports.data?void(angular.isString(this.options.organization)&&angular.isString(this.options.exhibition)&&angular.isString(this.options.scene)&&angular.isString(this.options.screen)?this._initializeServerConnection():this._delayedAbort("invalid-options","organization or exhibiton or scene or screen name is not in options")):void this._delayedAbort("browser-incompatiable","The curent browser does not support WebRTC")):new a(e)}var c=i.logger("ScreenPeer");return i.inherits(a,o),a.prototype.syncData=function(e){for(var t in this.connections.sync){var n=this.connections.sync[t];n.sendData(e)}},a.prototype.syncRequest=function(e,t,n){for(var o in this.connections.sync){var i=this.connections.sync[o];i.sendRequest(e,t,n)}},a.prototype.sendResponse=function(e,t,n){var o=this.connections.all[e];o.sendResponse(t,n)},a.prototype.sendData=function(e,t){var n=this.syncConnections[e];n?n.sendData(t):c.error("DataConneciton to",e,"is not exist!")},a.prototype.sendRequest=function(e,t,n,o){var i=this.connections.all[e];i?i.sendRequest(t,n,o):c.error("DataConneciton to",e,"is not exist!")},a.prototype._initializeServerConnection=function(){c.debug("Initialize server connection.");var e=this;this.socket=n(this.options.secure,this.options.host,this.options.port),this.socket.on("connect",function(){e.id=e.socket.id,c.debug("Catch socket `connect` event, emit screen options.",e.options),e.socket.emit("options",{organization:e.options.organization,exhibition:e.options.exhibition,scene:e.options.scene,screen:e.options.screen})}),this.socket.on("message",function(t){e._handleMessage(t)}),this.socket.on("error",function(t){e._abort("socket-error",t)}),this.socket.on("disconnect",function(){c.debug("Catch socket `disconnect` event"),e.emitError("network","Lost connection to server."),e.disconnected||e.disconnect()}),this.socket.on("close",function(){c.debug("Catch socket `close` event"),e.disconnected||e._abort("socket-closed","Underlying socket is already closed")})},a.prototype._updatePeers=function(e){var t=this,n=[];if(e.map(function(e){e._id===t.id&&(t.peerInScene=e),e.scene===t.options.scene&&n.push(e)}),this.peersInScene=n,this.master||n[0]._id!==this.id){if(this.master&&n[0]._id!==this.id){this.master=!1;for(var o in this.connections.all){var i=this.connections.all[o];i.originator&&i.destroy()}this.emit("master",!1)}}else this.master=!0,this.emit("master",!0);this.master&&this._tryConnectPeersInScene()},a.prototype._tryConnectPeersInScene=function(){var e=this;this.peersInScene.forEach(function(t){t._id===e.id||e.connections.all[t._id]||e.connect(t._id,{type:"sync"})})},a.prototype._handleMessage=function(e){var t,n=e.type,o=e.payload,i=e.src;switch(n){case"PEERS":c.debug("Receive message: PEERS in exhibition.",e.payload),this._updatePeers(e.payload),this.emit("open",this.id),this.open=!0;break;case"ERROR":c.error("Recive message: ERROR,",o.msg),this._abort("server-error",o.msg);break;case"SCREEN-TAKEN":c.error("Recive message: SCREEN-TAKEN"),this._abort("screen-exists",'SCREEN "'+this.options.organization+"/"+this.options.exhibition+"/"+this.options.scene+"/"+this.options.screen+'" is exists');break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":c.debug("Receive leave message from ",i,e),this._cleanupPeer(i);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+i);break;case"OFFER":var s=o.connectionId;c.debug("Receive message: OFFER from",i),t=this.getConnection(i,s),t?c.warn("Offer received for existing Connection ID:",s):(t=new r(i,this,{connectionId:s,_payload:o,metadata:o.metadata,type:o.type,label:o.label,serialization:o.serialization,reliable:o.reliable}),this._addConnection(i,t),this.emit("connection",t));var a=this._getMessages(s);a.forEach(function(e){t.handleMessage(e)});break;default:if(!o)return void c.debug("You receive a malformed message from "+i+" of type "+n);c.debug("Receive message:",n),t=this.getConnection(i),t&&t.pc?t.handleMessage(e):o.connectionId?this._storeMessage(o.connectionId,e):c.warn("You receive an unrecognized message:",e)}},a.prototype._storeMessage=function(e,t){this._lostMessages[e]||(this._lostMessages[e]=[]),this._lostMessages[e].push(t)},a.prototype._getMessages=function(e){var t=this._lostMessages[e];return t?(delete this._lostMessages[e],t):[]},a.prototype.connect=function(e,t){if(this.disconnected)return void c.warn("You cannot connect to a new Peer because you called .disconnect() on this peer.You can create a new peer to reconnect, or call reconnect on this peer if you believe its ID still be available");var n=new r(e,this,t);return this._addConnection(e,n),n},a.prototype._addConnection=function(e,t){this.connections[t.type]||(this.connections[t.type]={}),this.connections.all[e]=t,this.connections[t.type][e]=t},a.prototype.getConnection=function(e){return this.connections.all[e]},a.prototype.emitError=function(e,t){c.error("Error:",t),"string"==typeof t&&(t=new Error(t)),t.type=e,this.emit("error",t)},a.prototype.destroy=function(){this.destroyed||(this.socket.close(),this._cleanup(),this.removeAllListeners(),this.destroyed=!0,this.disconnected=!0,this.open=!1)},a.prototype._delayAbort=function(e,t){var n=this;s(function(){n._abort(e,t)})},a.prototype._abort=function(e,t){this.disconnect(),this.emitError(e,t)},a.prototype._cleanup=function(){for(var e in this.connections.all){var t=this.connections.all[e];t&&(delete this.connections.all[e],delete this.connections[t.type][e],t.destroy())}this._lostMessages={}},a.prototype.disconnect=function(){c.debug("Disconnect socket connection and close all data connection.");var e=this;s(function(){e.disconnected||(e.disconnected=!0,e.open=!1,e.socket&&e.socket.connected&&(c.debug("Disconnect socket",e.socket),e.socket.disconnect()),e._cleanup(),e.emit("disconnected",e.id),e.id=null)})},a.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)c.debug("Attempting reconnection to server with ID",this._lastServerId),this.socket.connect();else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from ther server");c.error("In a hurry?We're still trying to make initial connection!")}},a.prototype._cleanupPeer=function(e){var t=this.connections.all[e];t?(delete this.connections.all[e],delete this.connections[t.type][e],t.destroy()):c.warn("peer not exist",this.connections)},a}angular.module("screenPeer").factory("ScreenPeer",e)}(),function(){"use strict";function e(e,t,n,o,i,r,s){function a(e){return this instanceof a?(o.call(this),e=i.extend({config:i.defaultConfig},e),this.options=e,this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={all:{}},this._lostMessages={},this.master=!1,i.supports.audioVideo||i.supports.data?void(angular.isString(this.options.organization)&&angular.isString(this.options.exhibition)&&angular.isString(this.options.scene)&&angular.isString(this.options.screen)?this._initializeServerConnection():this._delayedAbort("invalid-options","organization or exhibiton or scene or screen name is not in options")):void this._delayedAbort("browser-incompatiable","The curent browser does not support WebRTC")):new a(e)}var c=i.logger("ScreenPeer");return i.inherits(a,o),a.prototype.syncData=function(e){for(var t in this.connections.sync){var n=this.connections.sync[t];n.sendData(e)}},a.prototype.syncRequest=function(e,t,n){for(var o in this.connections.sync){var i=this.connections.sync[o];i.sendRequest(e,t,n)}},a.prototype.sendResponse=function(e,t,n){var o=this.connections.all[e];o.sendResponse(t,n)},a.prototype.sendData=function(e,t){var n=this.syncConnections[e];n?n.sendData(t):c.error("DataConneciton to",e,"is not exist!")},a.prototype.sendRequest=function(e,t,n,o){var i=this.connections.all[e];i?i.sendRequest(t,n,o):c.error("DataConneciton to",e,"is not exist!")},a.prototype._initializeServerConnection=function(){c.debug("Initialize server connection.");var e=this;this.socket=n(this.options.secure,this.options.host,this.options.port),this.socket.on("connect",function(){e.id=e.socket.id,c.debug("Catch socket `connect` event, emit screen options.",e.options),e.socket.emit("options",{organization:e.options.organization,exhibition:e.options.exhibition,scene:e.options.scene,screen:e.options.screen})}),this.socket.on("message",function(t){e._handleMessage(t)}),this.socket.on("error",function(t){e._abort("socket-error",t)}),this.socket.on("disconnect",function(){c.debug("Catch socket `disconnect` event"),e.emitError("network","Lost connection to server."),e.disconnected||e.disconnect()}),this.socket.on("close",function(){c.debug("Catch socket `close` event"),e.disconnected||e._abort("socket-closed","Underlying socket is already closed")})},a.prototype._updatePeers=function(e){var t=this,n=[];if(e.map(function(e){e._id===t.id&&(t.peerInScene=e),e.scene===t.options.scene&&n.push(e)}),this.peersInScene=n,this.master||n[0]._id!==this.id){if(this.master&&n[0]._id!==this.id){this.master=!1;for(var o in this.connections.all){var i=this.connections.all[o];i.originator&&i.destroy()}this.emit("master",!1)}}else this.master=!0,this.emit("master",!0);this.master&&this._tryConnectPeersInScene()},a.prototype._tryConnectPeersInScene=function(){var e=this;this.peersInScene.forEach(function(t){t._id===e.id||e.connections.all[t._id]||e.connect(t._id,{type:"sync"})})},a.prototype._handleMessage=function(e){var t,n=e.type,o=e.payload,i=e.src;switch(n){case"PEERS":c.debug("Receive message: PEERS in exhibition.",e.payload),this._updatePeers(e.payload),this.emit("open",this.id),this.open=!0;break;case"ERROR":c.error("Recive message: ERROR,",o.msg),this._abort("server-error",o.msg);break;case"SCREEN-TAKEN":c.error("Recive message: SCREEN-TAKEN"),this._abort("screen-exists",'SCREEN "'+this.options.organization+"/"+this.options.exhibition+"/"+this.options.scene+"/"+this.options.screen+'" is exists');break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":c.debug("Receive leave message from ",i,e),this._cleanupPeer(i);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+i);break;case"OFFER":var s=o.connectionId;c.debug("Receive message: OFFER from",i),t=this.getConnection(i,s),t?c.warn("Offer received for existing Connection ID:",s):(t=new r(i,this,{connectionId:s,_payload:o,metadata:o.metadata,type:o.type,label:o.label,serialization:o.serialization,reliable:o.reliable}),this._addConnection(i,t),this.emit("connection",t));var a=this._getMessages(s);a.forEach(function(e){t.handleMessage(e)});break;default:if(!o)return void c.debug("You receive a malformed message from "+i+" of type "+n);c.debug("Receive message:",n),t=this.getConnection(i),t&&t.pc?t.handleMessage(e):o.connectionId?this._storeMessage(o.connectionId,e):c.warn("You receive an unrecognized message:",e)}},a.prototype._storeMessage=function(e,t){this._lostMessages[e]||(this._lostMessages[e]=[]),this._lostMessages[e].push(t)},a.prototype._getMessages=function(e){var t=this._lostMessages[e];return t?(delete this._lostMessages[e],t):[]},a.prototype.connect=function(e,t){if(this.disconnected)return void c.warn("You cannot connect to a new Peer because you called .disconnect() on this peer.You can create a new peer to reconnect, or call reconnect on this peer if you believe its ID still be available");var n=new r(e,this,t);return this._addConnection(e,n),n},a.prototype._addConnection=function(e,t){this.connections[t.type]||(this.connections[t.type]={}),this.connections.all[e]=t,this.connections[t.type][e]=t},a.prototype.getConnection=function(e){return this.connections.all[e]},a.prototype.emitError=function(e,t){c.error("Error:",t),"string"==typeof t&&(t=new Error(t)),t.type=e,this.emit("error",t)},a.prototype.destroy=function(){this.destroyed||(this.socket.close(),this._cleanup(),this.removeAllListeners(),this.destroyed=!0,this.disconnected=!0,this.open=!1)},a.prototype._delayAbort=function(e,t){var n=this;s(function(){
n._abort(e,t)})},a.prototype._abort=function(e,t){this.disconnect(),this.emitError(e,t)},a.prototype._cleanup=function(){for(var e in this.connections.all){var t=this.connections.all[e];t&&(delete this.connections.all[e],delete this.connections[t.type][e],t.destroy())}this._lostMessages={}},a.prototype.disconnect=function(){c.debug("Disconnect socket connection and close all data connection.");var e=this;s(function(){e.disconnected||(e.disconnected=!0,e.open=!1,e.socket&&e.socket.connected&&(c.debug("Disconnect socket",e.socket),e.socket.disconnect()),e._cleanup(),e.emit("disconnected",e.id),e.id=null)})},a.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)c.debug("Attempting reconnection to server with ID",this._lastServerId),this.socket.connect();else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from ther server");c.error("In a hurry?We're still trying to make initial connection!")}},a.prototype._cleanupPeer=function(e){var t=this.connections.all[e];t?(delete this.connections.all[e],delete this.connections[t.type][e],t.destroy()):c.warn("peer not exist",this.connections)},a}angular.module("screenPeer").factory("ScreenPeer",e)}(),!function(){"use strict";function e(e){return function(t,n,o){var i=t?"wss://":"ws://",r=i+n+":"+o;return e(r)}}angular.module("screenPeer").factory("Socket",e)}(),function(){"use strict";function e(e){return function(t,n,o){var i=t?"wss://":"ws://",r=i+n+":"+o;return e(r)}}angular.module("screenPeer").factory("Socket",e)}(),!function(){"use strict";function e(e,t,n,o,i,r,s){function a(e,t){return function(){var n=[].slice.call(arguments),o=Date.now();t.length<20?t=" ".repeat(20-t.length)+t:t.length>20&&(t="..."+t.substr(t.length-17,17)),o=o.toString().substr(8),n.unshift("background: "+p(t)+"; color: white;font-size:12px;padding:0 10px;line-height:1.2;"),n.unshift("%c"+t+">"),e.apply(null,n)}}function c(e){var t=0;switch(s.logLevel){case"debug":t=0;break;case"log":t=1;break;case"info":t=2;break;case"warn":t=3;break;default:t=4}return{debug:0>=t?a(n.debug,e):function(){},log:1>=t?a(n.log,e):function(){},info:2>=t?a(n.info,e):function(){},warn:3>=t?a(n.warn,e):function(){},error:4>=t?a(n.error,e):function(){}}}var d={iceServers:[{url:"stun:stun.l.google.com:19302"}]},u=1,p=r.scale.category20(),h=(c("util"),{noop:function(){},logger:c,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,defaultConfig:d,browser:function(){return o.mozRTCPeerConnection?"Firefox":o.webkitRTCPeerConnection?"Chrome":o.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){if("undefined"==typeof e)return{};var t,n,r=!0,s=!0,a=!1,c=!1,u=!!o.webkitRTCPeerConnection;try{t=new e(d,{optional:[{RtpDataChannels:!0}]})}catch(p){r=!1,s=!1}if(r)try{n=t.createDataChannel("_PEERJSTEST")}catch(p){r=!1}if(r){try{n.binaryType="blob",a=!0}catch(p){}var l=new e(d,{});try{var f=l.createDataChannel("_PEERJSRELIABLETEST",{});c=f.reliable}catch(p){}l.close()}if(s&&(s=!!t.addStream),!u&&r){var g=new e(d,{optional:[{RtpDataChannels:!0}]});g.onnegotiationneeded=function(){u=!0,h&&h.supports&&(h.supports.onnegotiationneeded=!0)},g.createDataChannel("_PEERJSNEGOTIATIONTEST"),i(function(){g.close()},1e3)}return t&&t.close(),{audioVideo:s,data:r,binaryBlob:a,sctp:c,onnegotiationneeded:u}}(),validateId:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:t.pack,unpack:t.unpack,arrayBufferConcat:function(e){var t=0;e.forEach(function(e){t+=e.byteLength});var n=new Uint8Array(t),o=0;return e.forEach(function(e,t){n.set(new Uint8Array(e),o),o+=e.byteLength}),n},chunkBuffer:function(e){for(var t=[],n=e.length,o=0,i=0,r=Math.ceil(n/h.chunkedMTU);n>o;){var s=Math.min(n,o+h.chunkedMTU),a=e.slice(o,s),c={__peerData:u,n:i,data:a,total:r};t.push(c),o=s,i+=1}return u+=1,t},chunkString:function(e){for(var t=[],n=e.length,o=0,i=0,r=Math.ceil(n/h.chunkedMTU);n>o;){var s=Math.min(n,o+h.chunkedMTU),a=e.slice(o,s),c={__peerData:u,n:i,data:a,total:r};t.push(c),o=s,i+=1}return u+=1,t},chunk:function(e){for(var t=[],n=e.size,o=0,i=0,r=Math.ceil(n/h.chunkedMTU);n>o;){var s=Math.min(n,o+h.chunkedMTU),a=e.slice(o,s),c={__peerData:u,n:i,data:a,total:r};t.push(c),o=s,i+=1}return u+=1,t},blobToArrayBuffer:function(e,t){var n=new o.FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https"===o.location.protocol}});return h}angular.module("screenPeer").factory("util",e)}(),function(){"use strict";function e(e,t,n,o,i,r,s){function a(e,t){return function(){var n=[].slice.call(arguments),o=Date.now();t.length<20?t=" ".repeat(20-t.length)+t:t.length>20&&(t="..."+t.substr(t.length-17,17)),o=o.toString().substr(8),n.unshift("background: "+p(t)+"; color: white;font-size:12px;padding:0 10px;line-height:1.2;"),n.unshift("%c"+t+">"),e.apply(null,n)}}function c(e){var t=0;switch(s.logLevel){case"debug":t=0;break;case"log":t=1;break;case"info":t=2;break;case"warn":t=3;break;default:t=4}return{debug:0>=t?a(n.debug,e):function(){},log:1>=t?a(n.log,e):function(){},info:2>=t?a(n.info,e):function(){},warn:3>=t?a(n.warn,e):function(){},error:4>=t?a(n.error,e):function(){}}}var d={iceServers:[{url:"stun:stun.l.google.com:19302"}]},u=1,p=r.scale.category20(),h=(c("util"),{noop:function(){},logger:c,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,defaultConfig:d,browser:function(){return o.mozRTCPeerConnection?"Firefox":o.webkitRTCPeerConnection?"Chrome":o.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){if("undefined"==typeof e)return{};var t,n,r=!0,s=!0,a=!1,c=!1,u=!!o.webkitRTCPeerConnection;try{t=new e(d,{optional:[{RtpDataChannels:!0}]})}catch(p){r=!1,s=!1}if(r)try{n=t.createDataChannel("_PEERJSTEST")}catch(p){r=!1}if(r){try{n.binaryType="blob",a=!0}catch(p){}var l=new e(d,{});try{var f=l.createDataChannel("_PEERJSRELIABLETEST",{});c=f.reliable}catch(p){}l.close()}if(s&&(s=!!t.addStream),!u&&r){var g=new e(d,{optional:[{RtpDataChannels:!0}]});g.onnegotiationneeded=function(){u=!0,h&&h.supports&&(h.supports.onnegotiationneeded=!0)},g.createDataChannel("_PEERJSNEGOTIATIONTEST"),i(function(){g.close()},1e3)}return t&&t.close(),{audioVideo:s,data:r,binaryBlob:a,sctp:c,onnegotiationneeded:u}}(),validateId:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:t.pack,unpack:t.unpack,arrayBufferConcat:function(e){var t=0;e.forEach(function(e){t+=e.byteLength});var n=new Uint8Array(t),o=0;return e.forEach(function(e,t){n.set(new Uint8Array(e),o),o+=e.byteLength}),n},chunkBuffer:function(e){for(var t=[],n=e.length,o=0,i=0,r=Math.ceil(n/h.chunkedMTU);n>o;){var s=Math.min(n,o+h.chunkedMTU),a=e.slice(o,s),c={__peerData:u,n:i,data:a,total:r};t.push(c),o=s,i+=1}return u+=1,t},chunkString:function(e){for(var t=[],n=e.length,o=0,i=0,r=Math.ceil(n/h.chunkedMTU);n>o;){var s=Math.min(n,o+h.chunkedMTU),a=e.slice(o,s),c={__peerData:u,n:i,data:a,total:r};t.push(c),o=s,i+=1}return u+=1,t},chunk:function(e){for(var t=[],n=e.size,o=0,i=0,r=Math.ceil(n/h.chunkedMTU);n>o;){var s=Math.min(n,o+h.chunkedMTU),a=e.slice(o,s),c={__peerData:u,n:i,data:a,total:r};t.push(c),o=s,i+=1}return u+=1,t},blobToArrayBuffer:function(e,t){var n=new o.FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https"===o.location.protocol}});return h}angular.module("screenPeer").factory("util",e)}();